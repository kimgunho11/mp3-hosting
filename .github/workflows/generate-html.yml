name: Generate and Deploy index.html

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate index.html with all media files
        run: |
          echo '<!DOCTYPE html>' > index.html
          echo '<html lang="ko">' >> index.html
          echo '<head><meta charset="UTF-8"><title>ğŸ“ íŒŒì¼ ëª©ë¡</title></head>' >> index.html
          echo '<body>' >> index.html
          echo '<h1>ğŸ“ ì—…ë¡œë“œëœ íŒŒì¼ ëª©ë¡</h1>' >> index.html
          echo '<table border="1" cellspacing="0" cellpadding="5">' >> index.html
          echo '<tr><th>íŒŒì¼ëª…</th><th>ë¯¸ë¦¬ë³´ê¸°</th><th>ì—…ë¡œë“œ ì‹œê°„</th></tr>' >> index.html

          for file in $(ls *.* 2>/dev/null | sort -V); do
            time=$(git log -1 --format="%cd" --date=format:'%Y-%m-%d %H:%M:%S' -- "$file")
            preview="-"

            case "$file" in
              *.mp3)
                preview="<audio controls src=\"$file\"></audio>"
                ;;
              *.png|*.jpg|*.jpeg|*.gif)
                preview="<img src=\"$file\" width=\"100\">"
                ;;
            esac

            echo "<tr><td><a href=\"$file\">$file</a></td><td>$preview</td><td>$time</td></tr>" >> index.html
          done

          echo '</table>' >> index.html
          echo '</body></html>' >> index.html

      - name: Commit and push index.html
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add index.html
          git commit -m "ğŸ”„ index.html ìë™ ì—…ë°ì´íŠ¸" || echo "No changes to commit"
          git push
